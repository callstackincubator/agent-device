[{"title":"","content":"<NotFoundLayout />\n","routePath":"/404","lang":"en","toc":[],"frontmatter":{"pageType":"custom"},"version":""},{"title":"Batching","content":"Use `batch` to run multiple commands in a single daemon request.\n\nThis is useful for agent workflows that already know the next sequence of actions and want to reduce orchestration overhead.\n\n## CLI examples\n\nFrom a file:\n\n```bash\nagent-device batch \\\n  --session sim \\\n  --platform ios \\\n  --udid 00008150-001849640CF8401C \\\n  --steps-file /tmp/batch-steps.json \\\n  --json\n```\n\nInline for small payloads:\n\n```bash\nagent-device batch --steps '[{\"command\":\"open\",\"positionals\":[\"settings\"]},{\"command\":\"wait\",\"positionals\":[\"100\"]}]'\n```\n\n## Step payload format\n\n`batch` accepts a JSON array of steps:\n\n```json\n[\n  { \"command\": \"open\", \"positionals\": [\"settings\"], \"flags\": {} },\n  { \"command\": \"wait\", \"positionals\": [\"label=\\\"Privacy & Security\\\"\", \"3000\"], \"flags\": {} },\n  { \"command\": \"click\", \"positionals\": [\"label=\\\"Privacy & Security\\\"\"], \"flags\": {} },\n  { \"command\": \"get\", \"positionals\": [\"text\", \"label=\\\"Tracking\\\"\"], \"flags\": {} }\n]\n```\n\nNotes:\n\n- `positionals` is optional (defaults to `[]`).\n- `flags` is optional (defaults to `{}`).\n- nested `batch` and `replay` steps are rejected.\n- `--on-error stop` is the supported behavior.\n\n## Response shape\n\nSuccess:\n\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"total\": 4,\n    \"executed\": 4,\n    \"totalDurationMs\": 1810,\n    \"results\": [\n      { \"step\": 1, \"command\": \"open\", \"ok\": true, \"durationMs\": 1020 },\n      { \"step\": 2, \"command\": \"wait\", \"ok\": true, \"durationMs\": 320 },\n      { \"step\": 3, \"command\": \"click\", \"ok\": true, \"durationMs\": 260 },\n      { \"step\": 4, \"command\": \"get\", \"ok\": true, \"durationMs\": 210, \"data\": { \"text\": \"...\" } }\n    ]\n  }\n}\n```\n\nFailure:\n\n```json\n{\n  \"success\": false,\n  \"error\": {\n    \"code\": \"COMMAND_FAILED\",\n    \"message\": \"Batch failed at step 3 (click): ...\",\n    \"details\": {\n      \"step\": 3,\n      \"command\": \"click\",\n      \"positionals\": [\"label=\\\"Privacy & Security\\\"\"],\n      \"executed\": 2,\n      \"total\": 4,\n      \"partialResults\": [\n        { \"step\": 1, \"command\": \"open\", \"ok\": true },\n        { \"step\": 2, \"command\": \"wait\", \"ok\": true }\n      ]\n    }\n  }\n}\n```\n\n## Agent best practices\n\n- Batch only one related screen flow at a time.\n- After mutating steps (`open`, `click`, `fill`, `swipe`), add a sync guard (`wait`, `is exists`) before critical reads.\n- Treat prior refs/snapshots as stale after UI changes.\n- Prefer `--steps-file` over inline JSON.\n- Keep batches moderate (about 5-20 steps).\n- Replan from the failing step using `details.step` and `details.partialResults`.\n\n## Stale accessibility tree risk\n\nRapid UI changes can outpace accessibility tree updates. Mitigate by inserting explicit waits and splitting long workflows into phases:\n\n1. navigate\n2. verify/extract\n3. cleanup\n","routePath":"/docs/batching","lang":"en","toc":[{"id":"cli-examples","text":"CLI examples","depth":2,"charIndex":192},{"id":"step-payload-format","text":"Step payload format","depth":2,"charIndex":538},{"id":"response-shape","text":"Response shape","depth":2,"charIndex":1148},{"id":"agent-best-practices","text":"Agent best practices","depth":2,"charIndex":2076},{"id":"stale-accessibility-tree-risk","text":"Stale accessibility tree risk","depth":2,"charIndex":2495}],"frontmatter":{"title":"Batching"},"version":"","description":"Use batch to run multiple commands in a single daemon request. This is useful for agent workflows that already know the next sequence of actions and want to reduce orchestration overhead."},{"title":"Commands","content":"This page summarizes the primary command groups.\n\n## Navigation\n\n```bash\nagent-device boot\nagent-device boot --platform ios\nagent-device boot --platform android\nagent-device open [app|url] [url]\nagent-device close [app]\nagent-device back\nagent-device home\nagent-device app-switcher\n```\n\n- `boot` ensures the selected target is ready without launching an app.\n- `boot` requires either an active session or an explicit device selector.\n- `boot` is mainly needed when starting a new session and `open` fails because no booted simulator/emulator is available.\n- `open [app|url] [url]` already boots/activates the selected target when needed.\n- `open <url>` deep links are supported on Android and iOS.\n- `open <app> <url>` opens a deep link on iOS.\n- On iOS devices, `http(s)://` URLs open in Safari when no app is active. Custom scheme URLs require an active app in the session.\n\n```bash\nagent-device open \"https://example.com\" --platform ios           # open link in web browser\nagent-device open MyApp \"myapp://screen/to\" --platform ios       # open deep link to MyApp\n```\n\n## Snapshot and inspect\n\n```bash\nagent-device snapshot [-i] [-c] [-d <depth>] [-s <scope>] [--raw]\nagent-device diff snapshot [-i] [-c] [-d <depth>] [-s <scope>] [--raw]\nagent-device get text @e1\nagent-device get attrs @e1\n```\n\n- iOS snapshots use XCTest on simulators and physical devices.\n- `diff snapshot` compares the current snapshot with the previous session baseline and then updates baseline.\n\n## Interactions\n\n```bash\nagent-device click @e1\nagent-device focus @e2\nagent-device fill @e2 \"text\"          # Clear then type\nagent-device type \"text\"              # Type into focused field without clearing\nagent-device press 300 500\nagent-device press 300 500 --count 12 --interval-ms 45\nagent-device press 300 500 --count 6 --hold-ms 120 --interval-ms 30 --jitter-px 2\nagent-device swipe 540 1500 540 500 120\nagent-device swipe 540 1500 540 500 120 --count 8 --pause-ms 30 --pattern ping-pong\nagent-device longpress 300 500 800\nagent-device scroll down 0.5\nagent-device scrollintoview \"Sign in\"\nagent-device scrollintoview @e42\nagent-device pinch 2.0          # zoom in 2x (iOS simulator)\nagent-device pinch 0.5 200 400 # zoom out at coordinates (iOS simulator)\n```\n\n`fill` clears then types. `type` does not clear.\nOn Android, `fill` also verifies text and performs one clear-and-retry pass on mismatch.\n`swipe` accepts an optional `durationMs` argument (default `250ms`, range `16..10000`).\nOn iOS, swipe duration is clamped to a safe range (`16..60ms`) to avoid longpress side effects.\n`scrollintoview` accepts plain text or a snapshot ref (`@eN`); ref mode uses best-effort geometry-based scrolling without post-scroll verification. Run `snapshot` again before follow-up `@ref` commands.\n`longpress` is supported on iOS and Android.\n`pinch` is iOS simulator-only.\n\n## Find (semantic)\n\n```bash\nagent-device find \"Sign In\" click\nagent-device find label \"Email\" fill \"user@example.com\"\nagent-device find role button click\n```\n\n## Replay\n\n```bash\nagent-device open Settings --platform ios --session e2e --save-script [path]\nagent-device replay ./session.ad      # Run deterministic replay from .ad script\nagent-device replay -u ./session.ad   # Update selector drift and rewrite .ad script in place\n```\n\n- `replay` runs deterministic `.ad` scripts.\n- `replay -u` updates stale recorded actions and rewrites the same script.\n- `--save-script` records a replay script on `close`; optional path is a file path and parent directories are created.\n\nSee [Replay & E2E (Experimental)]() for recording and CI workflow details.\n\n## Batch\n\n```bash\nagent-device batch --steps-file /tmp/batch-steps.json --json\nagent-device batch --steps '[{\"command\":\"open\",\"positionals\":[\"settings\"]}]'\n```\n\n- `batch` runs a JSON array of steps in a single daemon request.\n- each step has `command`, optional `positionals`, and optional `flags`.\n- stop-on-first-error is the supported behavior (`--on-error stop`).\n- use `--max-steps <n>` to tighten per-request safety limits.\n\nSee [Batching]() for payload format, response shape, and usage guidelines.\n\n## App reinstall (fresh state)\n\n```bash\nagent-device reinstall com.example.app ./build/app.apk --platform android\nagent-device reinstall com.example.app ./build/MyApp.app --platform ios\n```\n\n- `reinstall <app> <path>` uninstalls and installs in one command.\n- Supports Android devices/emulators and iOS simulators.\n- Useful for login/logout reset flows and deterministic test setup.\n\n## Settings helpers\n\n```bash\nagent-device settings wifi on\nagent-device settings wifi off\nagent-device settings airplane on\nagent-device settings airplane off\nagent-device settings location on\nagent-device settings location off\nagent-device settings faceid match\nagent-device settings faceid nonmatch\nagent-device settings faceid enroll\nagent-device settings faceid unenroll\n```\n\n- iOS `settings` support is simulator-only.\n- Face ID controls are iOS simulator-only.\n- Use `match`/`nonmatch` to simulate valid/invalid Face ID outcomes.\n\n## App state and app lists\n\n```bash\nagent-device appstate\nagent-device apps --platform ios\nagent-device apps --platform ios --all\nagent-device apps --platform android\nagent-device apps --platform android --all\n```\n\n- Android `appstate` reports live foreground package/activity.\n- iOS `appstate` is session-scoped and reports the app tracked by the active session on the target device.\n- `apps` includes default/system apps by default (use `--user-installed` to filter).\n\n## Media and logs\n\n```bash\nagent-device screenshot                 # Auto filename\nagent-device screenshot page.png        # Explicit screenshot path\nagent-device record start               # Start screen recording to auto filename\nagent-device record start session.mp4   # Start recording to explicit path\nagent-device record start session.mp4 --fps 30  # Override iOS device runner FPS\nagent-device record stop                # Stop active recording\n```\n\n**Session app logs (token-efficient debugging):** Logs are written to a file so agents can grep instead of loading full output into context.\n\n```bash\nagent-device logs path                  # Print session log file path (e.g. ~/.agent-device/sessions/default/app.log)\nagent-device logs start                 # Start streaming app stdout/stderr to that file (requires open first)\nagent-device logs stop                  # Stop streaming\nagent-device logs doctor                # Show logs backend/tool checks and readiness hints\nagent-device logs mark \"before submit\"  # Insert timeline marker into app.log\n```\n\n- Supported on iOS simulator, iOS physical device, and Android.\n- `logs start` appends to `app.log` and rotates to `app.log.1` when the file exceeds 5 MB.\n- Android log streaming automatically rebinds to the app PID after process restarts.\n- iOS log capture relies on Unified Logging signals (for example `os_log`); plain stdout/stderr output may be limited depending on app/runtime.\n- Retention knobs: set `AGENT_DEVICE_APP_LOG_MAX_BYTES` and `AGENT_DEVICE_APP_LOG_MAX_FILES` to override rotation limits.\n- Optional write-time redaction patterns: set `AGENT_DEVICE_APP_LOG_REDACT_PATTERNS` to a comma-separated regex list.\n\n**Grepping app logs:** Use `logs path` to get the file path, then run `grep` (or `grep -E`) on that path so only matching lines enter context—keeping token use low.\n\n```bash\n# Get path first (e.g. ~/.agent-device/sessions/default/app.log)\nagent-device logs path\n\n# Then grep the path; -n adds line numbers for reference\ngrep -n \"Error\\|Exception\\|Fatal\" ~/.agent-device/sessions/default/app.log\ngrep -n -E \"Error|Exception|Fatal|crash\" ~/.agent-device/sessions/default/app.log\n\n# Last 50 lines only (bounded context)\ntail -50 ~/.agent-device/sessions/default/app.log\n```\n\n- Use `-n` to include line numbers. Use `-E` for extended regex and `|` without escaping in the pattern.\n\n- Prefer targeted patterns (e.g. `Error`, `Exception`, your log tags) over reading the whole file.\n\n- iOS `record` works on simulators and physical devices.\n\n- iOS simulator recording uses native `simctl io ... recordVideo`.\n\n- Physical iOS device capture is runner-based and built from repeated `XCUIScreen.main.screenshot()` frames (no native video stream/audio capture).\n\n- Physical iOS device recording requires an active app session context (`open <app>` first).\n\n- Physical iOS device capture is best-effort: dropped frames are expected and true 60 FPS is not guaranteed even with `--fps 60`.\n\n- Physical-device capture defaults to uncapped (max available) FPS.\n\n- `--fps <n>` (1-120) applies to physical iOS device recording as an explicit FPS cap.\n\n## iOS device prerequisites\n\n- Xcode + `xcrun devicectl` available.\n- Paired physical device with Developer Mode enabled.\n- Use Automatic Signing in Xcode, or pass optional env overrides:\n  - `AGENT_DEVICE_IOS_TEAM_ID`\n  - `AGENT_DEVICE_IOS_SIGNING_IDENTITY` (optional)\n  - `AGENT_DEVICE_IOS_PROVISIONING_PROFILE`\n- If first-run XCTest setup/build is slow, increase daemon request timeout:\n  - `AGENT_DEVICE_DAEMON_TIMEOUT_MS=120000` (default is `90000`)\n- For daemon startup troubleshooting:\n  - follow stale metadata hints for `~/.agent-device/daemon.json` and `~/.agent-device/daemon.lock`\n","routePath":"/docs/commands","lang":"en","toc":[{"id":"navigation","text":"Navigation","depth":2,"charIndex":50},{"id":"snapshot-and-inspect","text":"Snapshot and inspect","depth":2,"charIndex":1073},{"id":"interactions","text":"Interactions","depth":2,"charIndex":1475},{"id":"find-semantic","text":"Find (semantic)","depth":2,"charIndex":2847},{"id":"replay","text":"Replay","depth":2,"charIndex":3006},{"id":"batch","text":"Batch","depth":2,"charIndex":3598},{"id":"app-reinstall-fresh-state","text":"App reinstall (fresh state)","depth":2,"charIndex":4105},{"id":"settings-helpers","text":"Settings helpers","depth":2,"charIndex":4489},{"id":"app-state-and-app-lists","text":"App state and app lists","depth":2,"charIndex":5026},{"id":"media-and-logs","text":"Media and logs","depth":2,"charIndex":5497},{"id":"ios-device-prerequisites","text":"iOS device prerequisites","depth":2,"charIndex":8625}],"frontmatter":{"title":"Commands"},"version":"","description":"This page summarizes the primary command groups."},{"title":"Installation","content":"## Global install\n\n```bash\nnpm install -g agent-device\n```\n\n## Without installing\n\n```bash\nnpx agent-device open Settings --platform ios\n```\n\n## Requirements\n\n- Node.js 22+\n- Xcode for iOS simulator/device automation (`simctl` + `devicectl`)\n- Android SDK / ADB for Android\n\n## iOS physical device prerequisites\n\n- Device is paired and visible in `xcrun devicectl list devices`.\n- Developer Mode enabled on device.\n- Signing configured in Xcode (Automatic Signing recommended), or use:\n- `AGENT_DEVICE_IOS_TEAM_ID`\n- `AGENT_DEVICE_IOS_SIGNING_IDENTITY`\n- `AGENT_DEVICE_IOS_PROVISIONING_PROFILE`\n- If device setup is slow, increase daemon timeout:\n  - `AGENT_DEVICE_DAEMON_TIMEOUT_MS=120000` (default is `90000`)\n- If daemon startup reports stale metadata, remove stale files and retry:\n  - `~/.agent-device/daemon.json`\n  - `~/.agent-device/daemon.lock`\n","routePath":"/docs/installation","lang":"en","toc":[{"id":"global-install","text":"Global install","depth":2,"charIndex":0},{"id":"without-installing","text":"Without installing","depth":2,"charIndex":60},{"id":"requirements","text":"Requirements","depth":2,"charIndex":142},{"id":"ios-physical-device-prerequisites","text":"iOS physical device prerequisites","depth":2,"charIndex":275}],"frontmatter":{"title":"Installation"},"version":""},{"title":"Introduction","content":"`agent-device` is a CLI for automating iOS simulators + physical devices and Android emulators + devices from agents. It provides:\n\n- Accessibility snapshots for UI understanding\n- Deterministic interactions (tap, type, scroll)\n- Session-aware workflows and replay\n\nIf you know `agent-browser`, this is the mobile-native counterpart for iOS/Android UI automation.\n\n## What it’s good at\n\n- Capturing structured UI state for LLMs\n- Driving common UI actions with refs or semantic selectors\n- Replaying flows for regression checks\n\n## Platform support highlights\n\n- iOS core runner commands: `snapshot`, `diff snapshot`, `wait`, `click`, `fill`, `get`, `is`, `find`, `press`, `long-press`, `focus`, `type`, `scroll`, `scrollintoview`, `back`, `home`, `app-switcher`, `open` (app), `close`, `screenshot`, `apps`, `appstate`.\n- iOS `appstate` is session-scoped on the selected target device.\n- iOS simulator-only: `alert`, `pinch`, `reinstall`, `settings`.\n- iOS `record` supports simulators and physical devices.\n  - Simulators use native `simctl io ... recordVideo`.\n  - Physical devices use runner screenshot capture (`XCUIScreen.main.screenshot()` frames) stitched into MP4, so FPS is best-effort (not guaranteed 60 even with `--fps 60`).\n  - Physical-device recording requires an active app session context (`open <app>` first).\n  - Physical-device recording defaults to uncapped (max available) FPS and supports `--fps` caps.\n- Android support remains unchanged.\n\n## Architecture (high level)\n\n1. CLI sends requests to the daemon.\n2. The daemon manages sessions and dispatches to platform drivers.\n3. iOS uses XCTest runner for snapshots and input on simulators and physical devices.\n4. Android uses ADB-based tooling.\n\n## Example\n\n```bash\n# Navigate and get snapshot\nagent-device open Settings --platform ios\nagent-device snapshot -i\n# Output\n# Page: Contacts\n# App: com.apple.MobileAddressBook\n# Snapshot: 44 nodes\n# @e1 [application] \"Contacts\"\n#  @e2 [window]\n#    @e3 [other]\n#  @e4 [other] \"Lists\"\n#    @e5 [navigation-bar] \"Lists\"\n#      @e6 [button] \"Lists\"\n#      @e7 [text] \"Contacts\"\n#    @e8 [other] \"John Doe\"\n\n# Click and fill\nagent-device click @e8\nagent-device snapshot -i\nagent-device diff snapshot\nagent-device fill @e5 \"Doe 2\"\nagent-device close\n```\n","routePath":"/docs/introduction","lang":"en","toc":[{"id":"what-its-good-at","text":"What it’s good at","depth":2,"charIndex":365},{"id":"platform-support-highlights","text":"Platform support highlights","depth":2,"charIndex":529},{"id":"architecture-high-level","text":"Architecture (high level)","depth":2,"charIndex":1465},{"id":"example","text":"Example","depth":2,"charIndex":1721}],"frontmatter":{"title":"Introduction"},"version":"","description":"agent-device is a CLI for automating iOS simulators + physical devices and Android emulators + devices from agents. It provides: Accessibility snapshots for UI understandingDeterministic interactions (tap, type, scroll)Session-aware workflows and replay If you know agent-browser, this is the mobile-native counterpart for iOS/Android UI automation."},{"title":"Known Limitations","content":"Platform constraints that affect automation behavior.\n\n## iOS: \"Allow Paste\" dialog suppressed under XCUITest\n\niOS 16+ shows an \"Allow Paste\" system prompt when an app reads `UIPasteboard.general` in the foreground. When an app is launched or activated through the XCUITest runner (which `agent-device` uses for iOS), the iOS runtime detects the testing context and silently grants pasteboard access — the prompt never appears.\n\nThis is an Apple platform constraint that affects all XCUITest-based automation tools.\n\n**Workarounds:**\n\n- **Pre-fill the pasteboard via simctl** — set clipboard content without triggering the dialog:\n  ```bash\n  echo \"some text\" | xcrun simctl pbcopy booted\n  ```\n- **Test the dialog manually** — the \"Allow Paste\" UX cannot be exercised through XCUITest-based automation.\n","routePath":"/docs/known-limitations","lang":"en","toc":[{"id":"ios-allow-paste-dialog-suppressed-under-xcuitest","text":"iOS: \"Allow Paste\" dialog suppressed under XCUITest","depth":2,"charIndex":55}],"frontmatter":{"title":"Known Limitations"},"version":"","description":"Platform constraints that affect automation behavior."},{"title":"Quick Start","content":"Every device automation follows this pattern:\n\n```bash\n# 1. Navigate\nagent-device open SampleApp --platform ios # or android\n\n# 2. Snapshot to get element refs\nagent-device snapshot -i\n# Output:\n# @e1 [heading] \"Sample App\"\n# @e2 [button] \"Settings\"\n\n# 3. Interact using refs\nagent-device click @e2\n\n# 4. Re-snapshot before next interactions\nagent-device snapshot -i\n\n# 5. Optional: see structural changes since last baseline\nagent-device diff snapshot\n```\n\nBoot target if there is no ready device/simulator:\n\n```bash\nagent-device boot --platform ios # or android\n```\n\n## Common commands\n\n```bash\nagent-device open SampleApp\nagent-device snapshot -i                 # Get interactive elements with refs\nagent-device diff snapshot               # First run initializes baseline; next runs show structural deltas\nagent-device click @e2                   # Click by ref\nagent-device fill @e3 \"test@example.com\" # Clear then type (Android verifies and retries once if needed)\nagent-device get text @e1                # Get text content\nagent-device screenshot page.png         # Save to specific path\nagent-device close\n```\n\nIf `open` fails because no booted simulator/emulator/device is available, run `boot --platform ios|android` and retry.\n\n## Fast batching\n\nWhen an agent already knows a short sequence of actions, batch them:\n\n```bash\nagent-device batch \\\n  --platform ios \\\n  --steps-file /tmp/batch-steps.json \\\n  --json\n```\n\nSee [Batching]() for payload format, failure handling, and best practices.\n\n## Semantic discovery\n\nUse `find` for human-readable targeting without refs:\n\n```bash\nagent-device find \"Sign In\" click\nagent-device find label \"Email\" fill \"user@example.com\"\nagent-device find role button click\n```\n\n## Replay (experimental)\n\nFor deterministic replay scripts and E2E guidance, see [Replay & E2E (Experimental)]().\n\n## Scrolling\n\nNavigate content that extends beyond the viewport:\n\n```bash\nagent-device scroll down 0.5            # Scroll down half screen\nagent-device scroll up 0.3              # Scroll up 30%\n```\n\n## Settings helpers\n\nToggle device settings directly:\n\n```bash\nagent-device settings wifi on\nagent-device settings airplane on\nagent-device settings location off\n```\n\nNote: iOS `settings` commands are simulator-only.\n\n## JSON output\n\nFor programmatic parsing in scripts:\n\n```bash\nagent-device snapshot --json\nagent-device get text @e1 --json\n```\n\nNote: The default text output is more compact and preferred for AI agents.\n","routePath":"/docs/quick-start","lang":"en","toc":[{"id":"common-commands","text":"Common commands","depth":2,"charIndex":569},{"id":"fast-batching","text":"Fast batching","depth":2,"charIndex":1241},{"id":"semantic-discovery","text":"Semantic discovery","depth":2,"charIndex":1506},{"id":"replay-experimental","text":"Replay (experimental)","depth":2,"charIndex":1723},{"id":"scrolling","text":"Scrolling","depth":2,"charIndex":1838},{"id":"settings-helpers","text":"Settings helpers","depth":2,"charIndex":2039},{"id":"json-output","text":"JSON output","depth":2,"charIndex":2257}],"frontmatter":{"title":"Quick Start"},"version":"","description":"Every device automation follows this pattern: Boot target if there is no ready device/simulator:"},{"title":"Replay & E2E Testing (Experimental)","content":"Agents use refs for exploration and authoring. Replay scripts are deterministic runs that can be used for E2E testing.\n\n## Core model\n\nTwo-pass workflow:\n\n1. Agent pass: discover and interact with refs (`snapshot` -> `click @e..` / `fill @e..`).\n2. Deterministic pass: run recorded `.ad` script with `replay`.\n\n## Record a replay script\n\nEnable recording during a session:\n\n```bash\nagent-device open Settings --platform ios --session e2e --save-script\nagent-device snapshot -i --session e2e\nagent-device click @e13 --session e2e\nagent-device close --session e2e\n```\n\nBy default, on `close`, a replay script is written to:\n\n```text\n~/.agent-device/sessions/<session>-<timestamp>.ad\n```\n\nYou can also provide a custom output file path:\n\n```bash\nagent-device open Settings --platform ios --session e2e --save-script ./workflows/e2e-settings.ad\n```\n\n- `--save-script` value is treated as a file path.\n- Parent directories are created automatically when they do not exist.\n- For ambiguous bare values, use `--save-script=workflow.ad` or a path-like value such as `./workflow.ad`.\n\n## Run replay\n\n```bash\nagent-device replay ~/.agent-device/sessions/e2e-2026-02-09T12-00-00-000Z.ad --session e2e-run\n```\n\n- Replay reads `.ad` scripts.\n\n## Update stale selectors in replay scripts\n\n```bash\nagent-device replay -u ~/.agent-device/sessions/e2e-2026-02-09T12-00-00-000Z.ad --session e2e-run\n```\n\nWhen a replay step fails, update can:\n\n- Take a fresh snapshot.\n- Resolve a stable replacement target.\n- Retry the step.\n- Rewrite the failing line in the same `.ad` file.\n\nCurrent update targets:\n\n- `click`\n- `fill`\n- `get`\n- `is`\n- `wait`\n\n## `replay -u` before/after examples\n\nExample 1: stale selector rewritten in place\n\n```sh\n# Before\nclick \"id=\\\"old_continue\\\" || label=\\\"Continue\\\"\"\n\n# After `replay -u`\nclick \"id=\\\"auth_continue\\\" || label=\\\"Continue\\\"\"\n```\n\nExample 2: stale ref-based action upgraded to selector form\n\n```sh\n# Before\nsnapshot -i -c -s \"Continue\"\nclick @e13 \"Continue\"\n\n# After `replay -u`\nsnapshot -i -c -s \"Continue\"\nclick \"id=\\\"auth_continue\\\" || label=\\\"Continue\\\"\"\n```\n\nUse `replay -u` locally during maintenance, review the rewritten `.ad` lines, then commit the updated script.\n\n## Troubleshooting\n\n- Replay fails after UI/layout changes:\n  - Run `replay -u` locally and review the rewritten lines.\n- Updating cannot resolve a unique target:\n  - Re-record that flow (`--save-script`) from a fresh exploratory pass.\n- Replay file parse error:\n  - Validate quoting in `.ad` lines (unclosed quotes are rejected).\n","routePath":"/docs/replay-e2e","lang":"en","toc":[{"id":"core-model","text":"Core model","depth":2,"charIndex":120},{"id":"record-a-replay-script","text":"Record a replay script","depth":2,"charIndex":311},{"id":"run-replay","text":"Run replay","depth":2,"charIndex":1076},{"id":"update-stale-selectors-in-replay-scripts","text":"Update stale selectors in replay scripts","depth":2,"charIndex":1230},{"id":"replay--u-beforeafter-examples","text":"`replay -u` before/after examples","depth":2,"charIndex":1628},{"id":"troubleshooting","text":"Troubleshooting","depth":2,"charIndex":2198}],"frontmatter":{"title":"Replay & E2E Testing (Experimental)"},"version":"","description":"Agents use refs for exploration and authoring. Replay scripts are deterministic runs that can be used for E2E testing."},{"title":"Selectors","content":"Use `find` to locate elements by semantic attributes instead of raw refs.\n\n```bash\nagent-device find \"Settings\" click\nagent-device find text \"Sign In\" click\nagent-device find label \"Email\" fill \"user@example.com\"\nagent-device find value \"Search\" type \"query\"\nagent-device find role button click\nagent-device find id \"com.example:id/login\" click\n```\n\nTips:\n\n- Use `find ... wait <timeoutMs>` to wait for UI to appear.\n- Combine with scoped snapshots using `snapshot -s \"<label>\"` for speed.\n- \\[Android] If a matched node is not hittable, agent-device will click/focus the nearest hittable ancestor.\n","routePath":"/docs/selectors","lang":"en","toc":[],"frontmatter":{"title":"Selectors"},"version":"","description":"Use find to locate elements by semantic attributes instead of raw refs. Tips: Use find ... wait <timeoutMs> to wait for UI to appear.Combine with scoped snapshots using snapshot -s \"<label>\" for speed.[Android] If a matched node is not hittable, agent-device will click/focus the nearest hittable ancestor."},{"title":"Sessions","content":"Sessions keep device state and snapshots consistent across commands.\n\n```bash\nagent-device open Settings --platform ios\nagent-device session list\nagent-device open Contacts          # change app while reusing the default session\nagent-device close\n```\n\nOpen another session independently (for parallel work):\n\n```bash\nagent-device open Contacts --platform ios --session my-session\nagent-device snapshot -i\nagent-device close --session my-session\n```\n\nNotes:\n\n- `open <app>` within an existing session switches the active app and updates the session bundle id.\n- `open <url>` in iOS sessions opens deep links.\n- `open <app> <url>` in iOS sessions opens deep links.\n- On iOS devices, `http(s)://` URLs open in Safari when no app is active. Custom scheme URLs require an active app in the session.\n- On iOS, `appstate` is session-scoped and requires a matching active session on the target device.\n- Use `--session <name>` to run multiple sessions in parallel.\n\nFor replay scripts and deterministic E2E guidance, see [Replay & E2E (Experimental)]().\n","routePath":"/docs/sessions","lang":"en","toc":[],"frontmatter":{"title":"Sessions"},"version":"","description":"Sessions keep device state and snapshots consistent across commands. Open another session independently (for parallel work): Notes: open <app> within an existing session switches the active app and updates the session bundle id.open <url> in iOS sessions opens deep links.open <app> <url> in iOS sessions opens deep links.On iOS devices, http(s):// URLs open in Safari when no app is active. Custom scheme URLs require an active app in the session.On iOS, appstate is session-scoped and requires a matching active session on the target device.Use --session <name> to run multiple sessions in parallel. For replay scripts and deterministic E2E guidance, see Replay & E2E (Experimental)."},{"title":"Snapshots","content":"Snapshots provide a structured view of the UI and generate stable refs.\n\n```bash\nagent-device snapshot                    # Full accessibility tree\nagent-device snapshot -i                 # Interactive elements only (recommended)\nagent-device snapshot -c                 # Compact (remove empty elements)\nagent-device snapshot -d 3               # Limit depth to 3 levels\nagent-device snapshot -s \"Contacts\"      # Scope to label/identifier\nagent-device snapshot -i -c -d 5         # Combine options\nagent-device diff snapshot               # Structural diff vs previous session baseline\n```\n\n| Option       | Description               |\n| ------------ | ------------------------- |\n| `-i`         | Interactive-only output   |\n| `-c`         | Compact structural noise  |\n| `-d <depth>` | Limit tree depth          |\n| `-s <scope>` | Scope to label/identifier |\n\nNote: If XCTest returns 0 nodes (foreground app changed), agent-device fails explicitly.\nIt does not automatically switch to AX.\n\n## Efficient snapshot usage\n\n- Default to `snapshot -i` for agent loops.\n- Add `-s \"<label>\"` (or `-s @ref`) to keep results screen-local.\n- Add `-d <depth>` when you only need upper hierarchy layers.\n- Re-snapshot after any UI mutation before reusing refs.\n- Use `diff snapshot` between mutations to validate structural changes with lower output volume.\n- Keep `--raw` for troubleshooting only.\n\n`diff snapshot` behavior:\n\n- First run initializes baseline (`baselineInitialized: true` in JSON).\n- Later runs return unified-style lines (`+` added, `-` removed, unchanged context) and update baseline after each call.\n\n## Example output:\n\n```bash\nagent-device snapshot -i\n# Output:\n# Snapshot: 44 nodes\n# @e1 [application] \"Contacts\"\n#   @e2 [window]\n#     @e3 [other]\n#   @e4 [other] \"Lists\"\n#     @e5 [navigation-bar] \"Lists\"\n#       @e6 [button] \"Lists\"\n#       @e7 [text] \"Contacts\"\n#     @e8 [other] \"John Doe\"\n#       @e9 [other] \"John Doe\"\n```\n\n## Backends (iOS):\n\n- `xctest` (default): full fidelity, fast, no Accessibility permission required.\n- `ax`: fast accessibility tree, may miss details, requires Accessibility permission; simulator-only.\n","routePath":"/docs/snapshots","lang":"en","toc":[{"id":"efficient-snapshot-usage","text":"Efficient snapshot usage","depth":2,"charIndex":995},{"id":"example-output","text":"Example output:","depth":2,"charIndex":1613},{"id":"backends-ios","text":"Backends (iOS):","depth":2,"charIndex":1946}],"frontmatter":{"title":"Snapshots"},"version":"","description":"Snapshots provide a structured view of the UI and generate stable refs. Note: If XCTest returns 0 nodes (foreground app changed), agent-device fails explicitly.\nIt does not automatically switch to AX."}]